generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  TEACHER
  STUDENT
}

enum QuizStatus {
  DRAFT
  ACTIVE
  COMPLETED
}

enum QuizType {
  INDIVIDUAL
  TEAM
}

model User {
  id          String  @id @default(uuid())
  firstName   String?
  lastName    String?
  phoneNumber String? @unique
  password    String?
  role        Role    @default(STUDENT)
  telegramId  String? // Teacher uchun tg bot notification

  createdQuizzes  Quiz[]             @relation("TeacherQuizzes")
  participations  QuizParticipants[]
  teamMemberships TeamMember[]
  answers         Answer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Quiz {
  id                  String     @id @default(uuid())
  title               String     @unique
  code                String     @unique
  type                QuizType   @default(INDIVIDUAL)
  status              QuizStatus @default(DRAFT)
  teacherId           String
  defaultQuestionTime Int? // seconds, e.g. 15
  totalTime           Int? // optional cashed sum of questions

  teacher      User               @relation("TeacherQuizzes", fields: [teacherId], references: [id], onDelete: Cascade)
  questions    Question[]
  participants QuizParticipants[]
  teams        Team[]

  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([code])
  @@index([teacherId])
  @@map("quizzes")
}

model Question {
  id        String @id @default(uuid())
  quizId    String
  text      String // Savol matni
  order     Int
  timeLimit Int    @default(10)

  quiz    Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  options Option[] // Kamida 2ta variant
  answers Answer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([quizId, order])
  @@index([quizId])
  @@map("questions")
}

model Option {
  id         String  @id @default(uuid())
  questionId String
  text       String // variant matni
  label      String // "A", "B", "C", ...
  isCorrect  Boolean @default(false)
  order      Int

  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade) // One question
  answers  Answer[] // Bu variantni tanlagan javoblar | many answers

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([questionId, label]) // label unique per question
  @@unique([questionId, order]) // order unique per question
  @@index([questionId])
  @@map("options")
}

model QuizParticipants {
  id     String  @id @default(uuid())
  quizId String
  userId String
  teamId String?
  score  Int     @default(0)

  quiz Quiz  @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team? @relation(fields: [teamId], references: [id], onDelete: SetNull)

  joinedAt DateTime @default(now())

  @@unique([quizId, userId])
  @@index([quizId])
  @@index([userId])
  @@index([teamId])
  @@map("quiz_participants")
}

model Team {
  id     String @id @default(uuid())
  quizId String
  name   String // jamoa nomi
  score  Int    @default(0) // jamoa umumiy bali

  quiz         Quiz               @relation(fields: [quizId], references: [id], onDelete: Cascade)
  participants QuizParticipants[]
  members      TeamMember[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([quizId])
  @@map("teams")
}

model TeamMember {
  id     String @id @default(uuid())
  teamId String
  userId String

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  joinedAt DateTime @default(now())

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("team_members")
}

model Answer {
  id         String  @id @default(uuid())
  questionId String
  userId     String
  optionId   String
  isCorrect  Boolean

  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  option   Option   @relation(fields: [optionId], references: [id], onDelete: Cascade)

  answeredAt DateTime @default(now())

  @@unique([questionId, userId]) // har bir savolga bir marta javob
  @@index([questionId])
  @@index([userId])
  @@index([optionId])
  @@map("answers")
}
