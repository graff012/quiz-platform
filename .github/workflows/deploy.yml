name: Deploy Backend to Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Allow manual trigger

jobs:
  deployment:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Free disk space
        run: |
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"

      - name: Deploy to Server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PORT: ${{ secrets.SERVER_PORT }}
          SSH_KEY: ${{ secrets.SSH_SECRET_KEY }}
          # Database
          DATABASE_USER: ${{ secrets.DATABASE_USER }}
          DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
          DATABASE_DB: ${{ secrets.DATABASE_DB }}
          DATABASE_DOCKER_URL: ${{ secrets.DATABASE_DOCKER_URL }}
          # App
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          # Write SSH key
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Test SSH connection
          echo "ðŸ”Œ Testing SSH connection..."
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=20 \
              -o ServerAliveInterval=30 \
              -o ServerAliveCountMax=40 \
              -p "${SERVER_PORT:-22}" \
              "$SERVER_USER@$SERVER_HOST" "echo 'âœ… SSH connection successful'" || exit 1

          # Deploy via SSH
          echo "ðŸ“¦ Deploying to server..."
          ssh -o StrictHostKeyChecking=no \
              -o ServerAliveInterval=30 \
              -o ServerAliveCountMax=240 \
              -o TCPKeepAlive=yes \
              -p "${SERVER_PORT:-22}" \
              "$SERVER_USER@$SERVER_HOST" << ENDSSH
          set -e
          
          REPO_DIR=\$HOME/quiz-app
          
          echo "ðŸ“ Setting up repository..."
          # Clone or pull
          if [ ! -d "\$REPO_DIR/.git" ]; then
            git clone https://github.com/graff012/quiz-platform.git "\$REPO_DIR"
          else
            cd "\$REPO_DIR"
            git fetch origin
            git reset --hard origin/master
            git pull origin master
          fi
          
          cd "\$REPO_DIR"
          echo "âœ… Code updated to latest version"
          
          # Create .env file directly on server with variable expansion
          echo "ðŸ“„ Creating .env file..."
          cat > .env << EOF
          NODE_ENV=production
          PORT=4000
          APP_PORT=8080
          
          # Database
          DATABASE_USER=$DATABASE_USER
          DATABASE_PASSWORD=$DATABASE_PASSWORD
          DATABASE_DB=$DATABASE_DB
          DATABASE_PORT=5433
          DATABASE_DOCKER_URL=$DATABASE_DOCKER_URL
          DATABASE_URL=postgresql://$DATABASE_USER:$DATABASE_PASSWORD@localhost:5433/$DATABASE_DB
          
          # JWT
          JWT_SECRET=$JWT_SECRET
          EOF
          
          echo "ðŸ›‘ Stopping existing containers..."
          sudo docker compose down || true
          
          # Kill any process using port 5433
          echo "ðŸ”“ Freeing up port 5433..."
          sudo lsof -ti:5433 | xargs sudo kill -9 || true
          
          # Remove any orphaned containers
          sudo docker ps -aq | xargs sudo docker rm -f || true
          
          echo "ðŸ—ï¸  Building new images..."
          sudo docker compose build --no-cache
          
          echo "ðŸš€ Starting containers..."
          sudo docker compose up -d
          
          echo "â³ Waiting for services to be healthy..."
          sleep 10
          
          echo "ðŸ” Checking container status..."
          sudo docker compose ps
          
          echo "ðŸ“Š Checking logs..."
          sudo docker compose logs --tail=50 nest-app
          
          echo "ðŸ§¹ Cleaning up unused images..."
          sudo docker image prune -af
          
          echo "âœ… Deployment completed successfully!"
          ENDSSH

      - name: Verify deployment
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
        run: |
          echo "ðŸ” Verifying deployment..."
          sleep 5
          curl -f http://$SERVER_HOST:8080/health || echo "âš ï¸  Health check failed, but deployment may still be starting..."

      - name: Clean up SSH key
        if: always()
        run: rm -f ~/.ssh/id_rsa
